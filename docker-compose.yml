services:
  api:
    build: .
    command: uvicorn service.app:app --host 0.0.0.0 --port 8000 --workers 2 --proxy-headers
    ports: ["8000:8000"]
    env_file:
      - ./configs/.env
    volumes:
      - ./:/app
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "python - <<'PY'\nimport sys,urllib.request;\ntry:\n  r=urllib.request.urlopen('http://localhost:8000/health',timeout=2)\n  sys.exit(0 if r.getcode()==200 else 1)\nexcept Exception:\n  sys.exit(1)\nPY"]
      interval: 20s
      timeout: 5s
      retries: 5

  ui:
    build: .
    command: streamlit run ui/dashboard.py --server.port=8501 --server.address=0.0.0.0
    ports: ["8501:8501"]
    env_file:
      - ./configs/.env
    depends_on: [api]
    volumes:
      - ./:/app
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "python - <<'PY'\nimport sys,urllib.request;\ntry:\n  r=urllib.request.urlopen('http://localhost:8501',timeout=2)\n  sys.exit(0 if r.getcode()==200 else 1)\nexcept Exception:\n  sys.exit(1)\nPY"]
      interval: 20s
      timeout: 5s
      retries: 5
