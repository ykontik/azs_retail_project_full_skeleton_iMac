# Model Card — Прогноз спроса (Retail)

## Обзор
- Задача: прогноз ежедневных продаж per‑SKU (магазин × семья товаров) для поддержки планирования запасов (SS/ROP).
- Вход: агрегированные продажные ряды, транзакции, цены на нефть, календарные и праздничные признаки, onpromotion.
- Выход: прогноз спроса (точка и квантили), метрики на holdout‑валидации.

## Данные
- Источник: Favorita‑подобный набор (train/transactions/oil/holidays_events/stores).
- Объём для демо: top‑N пар по сумме продаж за последние N дней.
- Подготовка: `etl.py` (Parquet + DuckDB), `make_features.py` (календарь, лаги, скользящие, onpromotion, holidays, oil, transactions).

## Модели
- Per‑SKU LightGBM (цели: MAE/Tweedie/Poisson), опционально квантильные модели (P50/P90).
- Глобальные: CatBoost, XGBoost (для сравнения и быстрых демо).
- Хранение: `models/{store}__{family}.joblib` (+ `__qXX.joblib` для квантилей).

## Тренировка и Валидация
- Holdout‑валидация по последним `valid_days`.
- Бейзлайны: Naive lag‑7, MA(7), отчёт о приросте качества vs baseline.
- Метрики: MAE, MAPE, CV‑MAE/CV‑MAPE (если включён time‑series CV).

## Метрики Качества (пример)
- Средний MAE/ MAPE сохраняются в `data_dw/summary_metrics.txt` и таблицу `data_dw/metrics_per_sku.csv`.
- Для глобальных моделей: `data_dw/metrics_global_*.json`.

## Ограничения и Допущения
- Качество чувствительно к уровню агрегации и полноте фич (цены, промо, внешние факторы).
- Квантильные модели приближённо оценивают дисперсию спроса; для точных интервалов нужна калибровка.
- Для категориальных фич в per‑SKU LightGBM используется встроенная поддержка с указанием категориальных колонок.

## Использование в Продукте
- API: `POST /predict_demand`, `POST /predict_demand_quantiles`, `POST /reorder_point` (SS/ROP).
- UI: Streamlit‑дашборд для интерактивной демонстрации, лидеров по качеству, ручного инференса.
- Экспорт: `scripts/export_onnx.py` (ONNX + опциональная INT8‑квантизация) для ускорения инференса.

## Мониторинг
- Приложение экспонирует Prometheus‑метрики: `/metrics-prom`.
- План расширения: мониторинг дрейфа данных/ошибки, алерты, отчёт по SLA.

## Воспроизводимость
- Фиксированный `random_state` во всех скриптах обучения.
- Команды в `Makefile`, шаблон `.env.example`, Docker Compose для изолированного запуска.

